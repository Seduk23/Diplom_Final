{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Lesson" %} {{ lesson.title }}{% endblock %}

{% block content %}
<div class="container mt-5" data-aos="fade-up">
    <h1 class="mb-4">{{ lesson.title }}</h1>
    {% include 'partials/messages.html' %}

    <!-- Карусель для перелистывания контента -->
    <div id="lessonCarousel" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-inner">
            <!-- Слайд 1: Описание -->
            {% if lesson.description %}
            <div class="carousel-item active">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">{% trans "Description" %}</h5>
                        <p class="card-text">{{ lesson.description|safe }}</p>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Слайд 2: Контент -->
            {% if lesson.content %}
            <div class="carousel-item {% if not lesson.description %}active{% endif %}">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">{% trans "Content" %}</h5>
                        <div class="card-text">{{ lesson.content|linebreaks }}</div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Слайд 3: Видео -->
            {% if lesson.video_url %}
            <div class="carousel-item">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">{% trans "Video" %}</h5>
                        <div class="embed-responsive embed-responsive-16by9">
                            <iframe class="embed-responsive-item" src="{{ lesson.video_url }}" allowfullscreen></iframe>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Слайды для тестов (для студентов) -->
            {% if user.is_student and has_test %}
            {% for test_data in tests %}
            <div class="carousel-item">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">{{ test_data.test.title }}</h5>
                        <p class="card-text">{{ test_data.test.description|safe }}</p>
                        {% if last_test_result %}
                        <p class="card-text">
                            {% trans "Your last score" %}: {{ last_test_result.score }}%
                            (<a href="{% url 'courses:test_results' lesson_id=lesson.id %}">{% trans "View all results" %}</a>)
                        </p>
                        {% endif %}
                        <!-- Форма теста -->
                        {% if test_data.form %}
                        <form method="post" class="mt-3 test-form" id="testForm_{{ test_data.test.id|escapejs }}">
                            {% csrf_token %}
                            <input type="hidden" name="test_id" value="{{ test_data.test.id|escapejs }}">
                            {{ test_data.form.as_p }}
                            <button type="submit" class="btn btn-primary" id="submitTest_{{ test_data.test.id|escapejs }}">{% trans "Submit Test" %}</button>
                        </form>
                        {% elif test_data.has_questions %}
                        <p class="text-danger">{% trans "You have exceeded the maximum number of attempts for this test." %}</p>
                        {% else %}
                        <p class="text-warning">{% trans "This test has no questions yet. Please contact your teacher." %}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <p class="text-warning">{% trans "No tests available for this lesson." %}</p>
            {% endif %}
        </div>

        <!-- Кнопки навигации -->
        {% if lesson.description or lesson.content or lesson.video_url or has_test %}
        <button class="carousel-control-prev" type="button" data-bs-target="#lessonCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">{% trans "Previous" %}</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#lessonCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">{% trans "Next" %}</span>
        </button>
        {% endif %}
    </div>

    <!-- Навигация по урокам -->
    <div class="d-flex justify-content-between mt-4">
        {% if prev_lesson %}
        <a href="{% url 'courses:lesson_detail' lesson_id=prev_lesson.id %}" class="btn btn-outline-secondary" data-aos="fade-right">
            {% trans "Previous Lesson" %}
        </a>
        {% endif %}
        {% if next_lesson and can_access_next_lesson %}
        <a href="{% url 'courses:lesson_detail' lesson_id=next_lesson.id %}" class="btn btn-outline-secondary" data-aos="fade-left">
            {% trans "Next Lesson" %}
        </a>
        {% elif next_lesson and user.is_student and has_test and not can_access_next_lesson %}
        <p class="text-warning">{% trans "Please pass the test with the required score to unlock the next lesson." %}</p>
        {% endif %}
    </div>

    <!-- Отладочная информация -->
    {% if debug %}
    <div class="card mt-4" data-aos="fade-up">
        <div class="card-body">
            <h5 class="card-title">Debug Info</h5>
            <pre>{{ debug|safe }}</pre>
        </div>
    </div>
    {% endif %}
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Находим все формы тестов
    const testForms = document.querySelectorAll('.test-form');
    testForms.forEach(function(form) {
        const testId = form.id.replace('testForm_', '');
        form.addEventListener('submit', function(e) {
            console.log('Form submitted for test ' + testId);
        });

        const submitButton = document.getElementById('submitTest_' + testId);
        if (submitButton) {
            submitButton.addEventListener('click', function(e) {
                console.log('Submit button clicked for test ' + testId);
            });
        }
    });
});
</script>
{% endblock %}
{% endblock %}